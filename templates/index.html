<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brain Tumor Detection</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- jQuery and jQuery UI -->
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <style>
        .image-container {
            display: inline-block;
            border: 2px dashed #ccc;
            padding: 5px;
            max-width: 100%;
            overflow: hidden;
        }

        .image {
            width: 100%;
            height: auto;
            display: block;
        }
    </style>
</head>

<body>
    <div class="container mt-5">
        <h1 class="text-center">Brain Tumor Detection</h1>
        <form id="uploadForm" enctype="multipart/form-data">
            <div class="mb-3">
                <label for="imageUpload" class="form-label">Upload Image (.png, .jpg, .jpeg)</label>
                <input class="form-control" type="file" id="imageUpload" accept=".png,.jpg,.jpeg" required>
            </div>
            <button type="submit" class="btn btn-primary">Upload & Analyze</button>
        </form>

        <div id="results" class="mt-5" style="display:none;">
            <h3>Results</h3>
            <div class="row">
                <div class="col-md-4">
                    <h5>Uploaded Image</h5>
                    <div class="image-container">
                        <img id="uploadedImage" src="" alt="Uploaded Image" class="image">
                    </div>
                </div>
                <div class="col-md-4">
                    <h5>Grad-CAM</h5>
                    <div class="image-container">
                        <img id="grad-cam" src="" alt="Grad-CAM" class="image">
                    </div>
                </div>
                <div class="col-md-4">
                    <h5>LIME</h5>
                    <div class="image-container">
                        <img id="lime" src="" alt="LIME" class="image">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <h5>Grayscale Viz</h5>
                        <div class="image-container">
                            <img id="grayscale_viz" src="" alt="LIME" class="image">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <h5>Overlay viz</h5>
                        <div class="image-container">
                            <img id="overlay_viz" src="" alt="LIME" class="image">
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6">
                    <div id="probabilities">
                    </div>
                </div>
                <div class="col-md-6">
                    <div id="predictionResult">
                    </div>
                </div>
            </div>
            <div class="row">
                <div id="chatSection" class="mt-5">
                    <h3>Chat with Medical Assistant</h3>
                    <div id="chatBox" class="border p-3 mb-3" style="height: 200px; overflow-y: scroll;"></div>
                    <input type="text" id="chatInput" class="form-control" placeholder="Type your message...">
                    <button id="sendChat" class="btn btn-success mt-2">Send</button>
                </div>
            </div>
        </div>
        <div class="row">
            <!-- code availability  -->
            <div class="container">
                <p class="text-center">
                    |
                    <a href="https://www.kaggle.com/code/lalithk90/covid-19-identification-with-chest-x-ray">Kaggle</a>
                    |
                    &nbsp;
                    |
                    <a href="https://github.com/LalithK90/Covid-19-Identification-with-Chest-X-Ray">Github - Model
                        Creation Code </a>
                    |
                    &nbsp;
                    |
                    <a href="https://github.com/LalithK90/Covid-19-Identification-with-Chest-X-Ray-Web-app">Github - Web
                        App Source Code</a>
                    |
                </p>
            </div>
            <!-- caution section  -->
            <div class="container-fluid bg-danger ">
                <p class="text-center text-white">This is not for medical diagnostic. </p>
            </div>
        </div>
    </div>
    <!-- Bootstrap Modal -->
    <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadModalLabel">Upload and Provide Additional Information</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Progress Spinner -->
                    <div id="progressSpinner" class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p>Uploading file and processing...</p>
                    </div>

                    <!-- Form Content -->
                    <div id="formContent">
                        <label for="medical_history" class="form-label">Medical History</label>
                        <br><small class="text-muted">Describes the patientâ€™s past medical records and
                            conditions.</small>
                        <textarea id="medical_history" class="form-control mb-2"
                            placeholder="Enter patient's medical history" rows="3"></textarea>

                        <label for="pt_description" class="form-label">Patient Description</label>
                        <br><small class="text-muted">General details about the patient, such as demographics or
                            personal
                            observations.</small>
                        <textarea id="pt_description" class="form-control mb-2" placeholder="Enter patient details"
                            rows="3"></textarea>

                        <label for="symptoms" class="form-label">Symptoms</label>
                        <br>
                        <small class="text-muted">Details about the symptoms the patient is experiencing.</small>
                        <textarea id="symptoms" class="form-control mb-2" placeholder="Describe symptoms"
                            rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <!-- <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button> -->
                    <button type="button" id="submitModalForm" class="btn btn-primary">Submit</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function () {
            let uploadedImageSrc;
            const probabilitiesDiv = $('#probabilities');

            $('#uploadForm').on('submit', function (e) {
                e.preventDefault();

                // Show the Bootstrap modal
                const modal = new bootstrap.Modal(document.getElementById('uploadModal'), {
                    backdrop: 'static', // Prevents closing when clicking outside
                    keyboard: false // Prevents closing with the ESC key
                });
                modal.show();

                // Show the progress spinner
                $('#progressSpinner').show();
                // disable submit button
                $('#submitModalForm').prop('disabled', true);

                // Prepare the form data for file upload
                const formData = new FormData();
                const fileInput = $('#imageUpload')[0];
                formData.append('file', fileInput.files[0]);

                // Perform the AJAX request to upload the file
                $.ajax({
                    url: '/upload',
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        // Hide the progress spinner and show the form
                        $('#progressSpinner').hide();
                        // active submit button
                        $('#submitModalForm').prop('disabled', false);

                        // Extract the file and prediction from the response
                        const file = fileInput.files[0];
                        const prediction = response.prediction;

                        // Process the uploaded image and display results
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = function (event) {
                                const uploadedImageSrc = event.target.result;
                                const img = new Image();
                                img.src = event.target.result;
                                img.onload = function () {
                                    const imgWidth = img.naturalWidth;
                                    const imgHeight = img.naturalHeight;

                                    // Update the UI with the uploaded image and prediction results
                                    $('#uploadedImage').attr('src', uploadedImageSrc).css({ "max-width": "100%" });
                                    $('#predictionResult').text(`Prediction: ${prediction}`);
                                    probabilitiesDiv.empty();
                                    for (const [label, prob] of Object.entries(response.probabilities)) {
                                        probabilitiesDiv.append(`  ${label}: ${Math.round(prob * 100)}%,  `);
                                    }
                                    $('#grad-cam').attr('src', 'data:image/png;base64,' + response.grad_cam).css({ "max-width": "100%" });
                                    $('#lime').attr('src', 'data:image/png;base64,' + response.lime).css({ "max-width": "100%" });
                                    $('#grayscale_viz').attr('src', 'data:image/png;base64,' + response.grayscale_viz).css({ "max-width": "100%" });
                                    $('#overlay_viz').attr('src', 'data:image/png;base64,' + response.overlay_viz).css({ "max-width": "100%" });
                                    $(".image-container").css({ "width": imgWidth, "height": imgHeight });

                                    // Show the results section
                                    $('#results').show();
                                    $('.image-container').resizable();
                                };
                            };
                            reader.readAsDataURL(file); // Read the file as a data URL
                        }
                    },
                    error: function (error) {
                        console.error('Error:', error);
                        modal.hide(); // Hide the modal in case of an error
                    }
                });
            });

            $('#submitModalForm').off('click').on('click', function () {
                const medical_history = $('#medical_history').val();
                const pt_description = $('#pt_description').val();
                const symptoms = $('#symptoms').val();
                const prediction = $('#probabilities').text();
                const fileInput = $('#imageUpload')[0];

                const formData = {
                    medical_history: medical_history,
                    pt_description: pt_description,
                    symptoms: symptoms,
                    prediction: prediction,
                    message: '',  // Assuming you want to pass this too
                };

                if (fileInput.files[0]) {
                    const file = fileInput.files[0];
                    const reader = new FileReader();

                    reader.onloadend = function () {
                        formData.file = reader.result;  // This will be base64 encoded
                        sendData(formData);
                    };

                    reader.readAsDataURL(file);  // Convert the file to base64
                } else {
                    sendData(formData);
                }

                function sendData (data) {
                    $.ajax({
                        url: '/chat',
                        type: 'POST',
                        contentType: 'application/json',  // Set to JSON content type
                        data: JSON.stringify(data),  // Send data as a JSON string
                        success: function (response) {
                            $('#chatBox').append(`<p><strong>RadioAI:</strong> ${response.response}</p>`);
                            console.log('Additional data saved successfully.', response);
                            modal.hide();
                        },
                        error: function (xhr) {
                            console.error('Error saving additional data:', xhr.responseText);
                        }
                    });
                }
            });

            $('#sendChat').on('click', function () {
                const message = $('#chatInput').val();
                if (message.trim() === '') return;

                $('#chatBox').append(`<p><strong>You:</strong> ${message}</p>`);
                $('#chatInput').val('');
                Swal.fire({
                    title: 'Processing...',
                    text: 'Please wait while we process your request.',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });
                $.post('/chat', { message }, function (response) {
                    $('#chatBox').append(`<p><strong>RadioAI:</strong> ${response.response}</p>`);
                    $('#chatBox').scrollTop($('#chatBox')[0].scrollHeight);
                    Swal.close();
                });
            });
        });
    </script>
</body>

</html>